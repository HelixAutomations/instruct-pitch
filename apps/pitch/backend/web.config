<configuration>
  <system.webServer>
    <handlers>
      <!-- Host Express directly via server.js (avoid indirection through app.js to prevent 0x00000002 file-not-found issues) -->
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
      <!-- Backup minimal diagnostic handler for when server.js fails -->
      <add name="hello-diag" path="hello.js" verb="GET" modules="iisnode" />
    </handlers>

    <!-- Optional: explicit MIME types (harmless even if already present) -->
    <staticContent>
      <mimeMap fileExtension=".js" mimeType="application/javascript" />
      <mimeMap fileExtension=".mjs" mimeType="application/javascript" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <mimeMap fileExtension=".css" mimeType="text/css" />
      <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
    </staticContent>

    <rewrite>
      <rules>
        <!-- 0) Minimal diagnostic handler for emergency debugging -->
        <rule name="HelloDiagToMinimal" stopProcessing="true">
          <match url="^hello-diag$" />
          <action type="Rewrite" url="hello.js" />
        </rule>

        <!-- 1) Health check and API routes go to Node first -->
        <rule name="HealthAndApiToNode" stopProcessing="true">
          <match url="^(health|api)(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 1a) High-priority diagnostic routes for debugging startup issues -->
        <rule name="DiagnosticRoutesToNode" stopProcessing="true">
          <match url="^(startup-check|diag|hello-diag)(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 1b) Test routes go to Node -->
        <rule name="TestRoutesToNode" stopProcessing="true">
          <match url="^(test|simple-test)(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 2) Root redirect to pitch -->
        <rule name="RootToPitch" stopProcessing="true">
          <match url="^$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 3) Serve real files from their physical path -->
        <rule name="ServeStatic" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>

        <!-- 4) Requests for assets (/*.js, /assets/*, etc.) should come from client/dist -->
        <rule name="StaticFromClientDist" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/(assets/.*|.*\.(js|mjs|css|map|png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf))$" />
          </conditions>
          <action type="Rewrite" url="client/dist{REQUEST_URI}" />
        </rule>

        <!-- 5) Pitch routes go to Node for SSR/prefill injection -->
        <rule name="PitchToNode" stopProcessing="true">
          <match url="^pitch(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 6) Everything else -> SPA index.html -->
        <rule name="SpaFallback" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/(health|api|pitch|test|simple-test)(/|$)" negate="true" />
          </conditions>
          <action type="Rewrite" url="client/dist/index.html" />
        </rule>
      </rules>
    </rewrite>
    <!-- iisnode diagnostics: Enable logging & devErrors temporarily for debugging.
      These settings help capture startup failures that would otherwise result in
      opaque 500.1001 errors. The logs will appear in Azure log stream.
      Note: loggingEnabled may cause permission issues in some environments,
      but devErrorsEnabled should work in most cases to show detailed errors. -->
  <iisnode 
    loggingEnabled="true" 
    devErrorsEnabled="true" 
    logDirectory="iisnode"
    debuggingEnabled="true"
    node_env="production"
    maxNamedPipeConnectionRetry="10"
    namedPipeConnectionRetryDelay="250"
    maxConcurrentRequestsPerProcess="1024"
    maxNamedPipePoolSize="512"
    initialRequestBufferSize="4096"
    maxRequestBufferSize="65536"
    promoteServerVars="REMOTE_ADDR,HTTP_X_FORWARDED_FOR,HTTP_X_FORWARDED_PROTO"
  />
  </system.webServer>
</configuration>
