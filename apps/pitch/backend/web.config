<configuration>
  <system.webServer>
    <handlers>
      <!-- Let IISNode host your Express app at /server.js in the site root -->
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <!-- Optional: explicit MIME types (harmless even if already present) -->
    <staticContent>
      <mimeMap fileExtension=".js" mimeType="application/javascript" />
      <mimeMap fileExtension=".mjs" mimeType="application/javascript" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <mimeMap fileExtension=".css" mimeType="text/css" />
      <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
    </staticContent>

    <rewrite>
      <rules>
        <!-- 0) Block direct access to server.js -->
        <rule name="BlockDirectServerJs" stopProcessing="true">
          <match url="^server\.js$" />
          <action type="CustomResponse" statusCode="404" statusReason="Not Found" statusDescription="Not Found" />
        </rule>

        <!-- 1) Serve real files from their physical path -->
        <rule name="ServeStatic" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>

        <!-- 2) Requests for assets (/*.js, /assets/*, etc.) should come from client/dist -->
        <rule name="StaticFromClientDist" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/(assets/.*|.*\.(js|mjs|css|map|png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf))$" />
          </conditions>
          <action type="Rewrite" url="client/dist{REQUEST_URI}" />
        </rule>

        <!-- 3) API goes to Node -->
        <rule name="ApiToNode" stopProcessing="true">
          <match url="^api(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 4) Pitch routes go to Node for SSR/prefill injection -->
        <rule name="PitchToNode" stopProcessing="true">
          <match url="^pitch(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 5) Everything else -> SPA index.html -->
        <rule name="SpaFallback" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/(api|pitch)(/|$)" negate="true" />
          </conditions>
          <action type="Rewrite" url="client/dist/index.html" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>
