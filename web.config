<configuration>
  <system.webServer>
    <handlers>
      <!-- Host Express directly via server.js (avoid indirection through app.js to prevent 0x00000002 file-not-found issues) -->
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <!-- Optional: explicit MIME types (harmless even if already present) -->
    <staticContent>
      <mimeMap fileExtension=".js" mimeType="application/javascript" />
      <mimeMap fileExtension=".mjs" mimeType="application/javascript" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <mimeMap fileExtension=".css" mimeType="text/css" />
      <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
    </staticContent>

    <rewrite>
      <rules>
        <!-- 1) Health check and API routes go to Node first -->
        <rule name="HealthAndApiToNode" stopProcessing="true">
          <match url="^(health|api)(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 1b) Test routes go to Node -->
        <rule name="TestRoutesToNode" stopProcessing="true">
          <match url="^(test|simple-test)(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 2) Root redirect to pitch -->
        <rule name="RootToPitch" stopProcessing="true">
          <match url="^$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 3) Serve real files from their physical path -->
        <rule name="ServeStatic" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>

        <!-- 4) Requests for assets (/*.js, /assets/*, etc.) should come from client/dist -->
        <rule name="StaticFromClientDist" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/(assets/.*|.*\.(js|mjs|css|map|png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf))$" />
          </conditions>
          <action type="Rewrite" url="client/dist{REQUEST_URI}" />
        </rule>

        <!-- 5) Pitch routes go to Node for SSR/prefill injection -->
        <rule name="PitchToNode" stopProcessing="true">
          <match url="^pitch(/.*)?$" />
          <action type="Rewrite" url="server.js" />
        </rule>

        <!-- 6) Everything else -> SPA index.html -->
        <rule name="SpaFallback" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/(health|api|pitch|test|simple-test)(/|$)" negate="true" />
          </conditions>
          <action type="Rewrite" url="client/dist/index.html" />
        </rule>
      </rules>
    </rewrite>
    <!-- iisnode diagnostics: disable file-based logging/devErrors to avoid
      cases where iisnode cannot create per-process log files due to permissions.
      Disable these so stdout/stderr is captured by App Service log-stream instead.
      Toggle back to true only temporarily when running as admin or with ensured
      write permissions to the app folder. -->
  <iisnode loggingEnabled="false" devErrorsEnabled="false" />
  </system.webServer>
</configuration>
